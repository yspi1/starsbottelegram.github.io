<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Stars</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a4cff;
            --neon: #00e0ff;
            --bg: #0f0f1a;
            --text: #fff;
            --card-bg: rgba(30,30,46,0.8);
            --danger: #ff4d6d;
            --success: #00e676;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(106,76,255,0.15) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(255,107,157,0.15) 0%, transparent 30%);
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 1000;
        }

        .loader-star {
            font-size: 60px;
            color: var(--neon);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .menu-icon {
            position: fixed;
            top: 16px;
            left: 16px;
            cursor: pointer;
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30,30,46,0.8);
            border-radius: 50%;
            border: 1px solid var(--primary);
            color: var(--neon);
            z-index: 100;
        }

        .menu {
            position: fixed;
            top: 70px;
            left: 16px;
            background: rgba(15,15,26,0.95);
            border-radius: 14px;
            padding: 12px;
            width: 220px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            display: none;
            z-index: 99;
        }

        .profile-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(106,76,255,0.3);
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--neon);
            box-shadow: 0 0 20px rgba(0,224,255,0.3);
        }

        .balance {
            font-size: 32px;
            margin: 20px 0;
            color: var(--neon);
            text-shadow: 0 0 10px rgba(0,224,255,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .stat-card {
            background: rgba(20,20,36,0.7);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(106,76,255,0.2);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30,30,46,0.9);
            padding: 12px 20px;
            border-radius: 10px;
            border-left: 4px solid var(--neon);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="loader-star">★</div>
    </div>

    <div class="menu-icon" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <div class="menu" id="menu">
        <button class="menu-item" onclick="showSection('profile')">
            <i class="fas fa-user"></i> Профиль
        </button>
        <button class="menu-item" onclick="showSection('game')">
            <i class="fas fa-gamepad"></i> Игра
        </button>
        <div class="menu-divider"></div>
        <button class="menu-item" onclick="showNotification('В разработке', 'info')">
            <i class="fas fa-wallet"></i> Кошелек
        </button>
    </div>

    <div class="profile-card" id="profile" style="display: none;">
        <img class="avatar" id="avatar" src="" alt="Аватар">
        <h2 id="username">Загрузка...</h2>
        <div class="balance" id="balance">0 ⭐</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="games">0</div>
                <div class="stat-label">Игр сыграно</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wins">0</div>
                <div class="stat-label">Побед</div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notification-text"></span>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "rfIdLaULMIe2uo0h3pygEj3lNjAUWrkEOgsyhSD1nE8",
            databaseURL: "https://stars-207f2-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = {
            id: null,
            data: null,
            ref: null
        };

        async function init() {
            try {
                if (!window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    showError();
                    return;
                }

                Telegram.WebApp.ready();
                Telegram.WebApp.expand();

                await loadUser();
                initUI();
            } catch (error) {
                console.error('Init error:', error);
                showError();
            }
        }

        async function loadUser() {
            const tgUser = Telegram.WebApp.initDataUnsafe.user;
            user.id = tgUser.id;
            user.ref = db.ref(`users/${user.id}`);

            const snapshot = await user.ref.once('value');
            if (!snapshot.exists()) {
                await createNewUser(tgUser);
            }
            
            user.data = snapshot.val() || {};
            initDataListeners();
        }

        async function createNewUser(tgUser) {
            const newUser = {
                name: tgUser.username || `${tgUser.first_name} ${tgUser.last_name}`,
                avatar: tgUser.photo_url || '',
                balance: 0,
                games: 0,
                wins: 0,
                created: Date.now()
            };

            await user.ref.set(newUser);
            user.data = newUser;
        }

        function initDataListeners() {
            user.ref.on('value', (snap) => {
                user.data = snap.val();
                updateUI();
            });
        }

        function updateUI() {
            document.getElementById('avatar').src = user.data.avatar;
            document.getElementById('username').textContent = user.data.name;
            document.getElementById('balance').textContent = `${user.data.balance} ⭐`;
            document.getElementById('games').textContent = user.data.games;
            document.getElementById('wins').textContent = user.data.wins;
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('profile').style.display = 'block';
        }

        function showNotification(text, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        function toggleMenu() {
            const menu = document.getElementById('menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function showError() {
            document.getElementById('loader').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="color: var(--danger);">Ошибка доступа</h2>
                    <p>Пожалуйста, откройте приложение через Telegram-бота</p>
                </div>
            `;
        }

        // Инициализация
        init();
    </script>
</body>
</html>
