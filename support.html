import os
from flask import Flask, request, jsonify, render_template_string
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import time
import logging
from threading import Thread
import telebot
from telebot import types

# Настройка логирования
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Конфигурация
class Config:
    BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', 'YOUR_BOT_TOKEN')
    ADMIN_IDS = [int(x) for x in os.getenv('ADMIN_IDS', '123456789').split(',')]
    REQUEST_DELAY = int(os.getenv('REQUEST_DELAY', '5'))
    WEBAPP_HOST = os.getenv('WEBAPP_HOST', '0.0.0.0')
    WEBAPP_PORT = int(os.getenv('WEBAPP_PORT', '5000'))
    WEBAPP_URL = os.getenv('WEBAPP_URL', 'https://yourdomain.com')

# Полный список почтовых аккаунтов
SENDERS = {
    'korlithiobtennick@mail.ru': 'feDLSiueGT89APb81v74',
    'avyavya.vyaavy@mail.ru': 'zmARvx1MRvXppZV6xkXj',
    'gdfds98@mail.ru': '1CtFuHTaQxNda8X06CaQ',
    'dfsdfdsfdf51@mail.ru': 'SXxrCndCR59s5G9sGc6L',
    'aria.therese.svensson@mail.com': 'Zorro1ab',
    'taterbug@verizon.net': 'Holly1!',
    'ejbrickner@comcast.net': 'Pass1178',
    'teressapeart@cox.net': 'Quinton2329!',
    'liznees@verizon.net': 'Dancer008',
    'olajakubovich@mail.com': 'OlaKub2106OlaKub2106',
    'kcdg@charter.net': 'Jennifer3*',
    'bean_118@hotmail.com': 'Liverpool118!',
    'dsdhjas@mail.com': 'LONGHACH123',
    'robitwins@comcast.net': 'May241996',
    'wasina@live.com': 'Marlas21',
    'aruzhan.01@mail.com': '1234567!',
    'rob.tackett@live.com': 'metallic',
    'lindahallenbeck@verizon.net': 'Anakin@2014',
    'hlaw82@mail.com': 'Snoopy37$$',
    'paintmadman@comcast.net': 'mycat2200*',
    'prideandjoy@verizon.net': 'Ihatejen12',
    'sdgdfg56@mail.com': 'kenwood4201',
    'garrett.danelz@comcast.net': 'N11golfer!',
    'gillian_1211@hotmail.com': 'Gilloveu1211',
    'sunpit16@hotmail.com': 'Putter34!',
    'fdshelor@verizon.net': 'Masco123*',
    'yeags1@cox.net': 'Zoomom1965!',
    'amine002@usa.com': 'iScrRoXAei123',
    'bbarcelo16@cox.net': 'Bsb161089$$',
    'laliebert@hotmail.com': 'pirates2',
    'vallen285@comcast.net': 'Delft285!1!',
    'sierra12@email.com': 'tegen1111',
    'luanne.zapevalova@mail.com': 'FqWtJdZ5iN@',
    'kmay@windstream.net': 'Nascar98',
    'redbrick1@mail.com': 'Redbrick11',
    'ivv9ah7f@mail.com': 'K226nw8duwg',
    'erkobir@live.com': 'floydLAWTON019',
    'Misscarter@mail.com': 'ashtray19',
    'carlieruby10@cox.net': 'Lollypop789$',
    'blackops2013@mail.com': 'amason123566',
    'caroline_cullum@comcast.net': 'carter14',
    'dpb13@live.com': 'Ic&ynum13',
    'heirhunter@usa.com': 'Noguys@714',
    'sherri.edwards@verizon.net': 'Dreaming123#',
    'rami.rami1980@hotmail.com': 'ramirami1980',
    'jmsingleton2@comcast.net': '151728Jn$$',
    'aberancho@aol.com': '10diegguuss10',
    'dgidel@iowatelecom.net': 'Buster48',
    'gpopandopul@mail.com': 'GEORG62A',
    'bolgodonsk@mail.com': '012345678!',
    'colbycolb@cox.net': 'Signals@1',
    'nicrey4@comcast.net': 'Dabears54',
    'mordechai@mail.com': 'Mordechai',
    'inemrzoya@mail.com': 'rLS1elaUrLS1elaU',
    'tarabedford@comcast.net': 'Money4me',
    'mycockneedsit@mail.com': 'benjamin3',
    'saralaine@mail.com': 'sarlaine12!1',
    'jonb2006@verizon.net': '1969Camaro',
    'rjhssa1@verizon.net': 'Donna613*',
    'cameron.doug@charter.net': 'Jake2122$',
    'bridget.shappell@comcast.net': 'Brennan1',
    'rugs8@comcast.net': 'baseball46',
    'averyjacobs3@mail.com': '1960682644!',
    'lstefanick@hotmail.com': 'Luv2dance2',
    'bchavez123@mail.com': 'aadrianachavez',
    'lukejamesjones@mail.com': 'tinkerbell1',
    'emahoney123@comcast.net': 'Shieknmme3#',
    'mandy10.mcevoy@btinternet.com': 'Tr1plets3',
    'jet747@cox.net': 'Sadie@1234',
    'landsgascareservices@mail.com': 'Alisha25@',
    'samantha224@mail.com': 'Madden098!@',
    'kbhamil@wowway.com': 'Carol1940',
    'email@bjasper.com': 'Lhsnh4us123!',
    'biggsbrian@cox.net': 'Trains@2247Trains@2247',
    'dzzeblnd@aol.com': 'Geosgal@1',
    'jtrego@indy.rr.com': 'Jackwill14!',
    'chrisphonte.rj@comcast.net': 'Junior@3311',
    'tvwifiguy@comcast.net': 'Bill#0101',
    'defenestrador@mail.com': 'm0rb1d8ss',
    'glangley@gmx.com': 'ironhide',
    'zmbuohbo@nietamail.com': 'bwhshijvS!7708',
    'mzwdxmbr@vecinomail.com': 'yogovhrcS!9604',
    'sdwljbvw@senoramail.com': 'fhfmqzwhS!3765',
    'bvmqjvxg@menormail.com': 'obcyxskhX!5435',
    'vpdsmckd@nietamail.com': 'soivmwqbA!4968',
    'rtckyhny@vecinomail.com': 'xxtgawjxX!8484',
    'etczzucr@senoramail.com': 'jlgflnfvS!9717',
    'muztpwnl@menormail.com': 'xplstfvnA!4629',
    'afbzgbqs@nietamail.com': 'hcthlbkkS!9664',
    'vwnajvtb@vecinomail.com': 'qpaufpfdX!6846',
    'ndnxnqst@senoramail.com': 'uamvwtvxY!4448',
    'aehbzvtn@menormail.com': 'pdzabldbX!1586',
    'yuofldqp@nietamail.com': 'uumnzcoqA!9950',
    'iryxsvsg@vecinomail.com': 'hcnkpndqY!3869',
    'adeppaas@senoramail.com': 'qdjmsbtrY!8595',
    'vbrexarm@menormail.com': 'mpyxepysX!5838',
    'uiwedngh@nietamail.com': 'xenlwbqqX!3150',
    'kgwbdctw@vecinomail.com': 'vgnbhgclX!7983',
    'yxjcdhet@senoramail.com': 'ykfdidaiY!2510',
    'hfrtvmrz@menormail.com': 'cirrohtjY!3834',
    'mpudwtru@nietamail.com': 'ofdhcbjqX!8197',
    'eoulmbhe@vecinomail.com': 'wdcytnqaY!2858',
    'diniduks@senoramail.com': 'qdatfzqaS!4552',
    'acpidkkq@menormail.com': 'slownwabX!7663',
    'nkpswjsb@nietamail.com': 'tjyaixxvY!7554',
    'charlotte2850@hotmail.com': 'kelalu2850'
}

RECEIVERS = [
    'sms@telegram.org', 'dmca@telegram.org', 'abuse@telegram.org',
    'sticker@telegram.org', 'support@telegram.org', 'topCA@telegram.org', 
    'recover@telegram.org', 'ceo@telegram.org'
]

# Полные тексты жалоб
COMPLAINT_TEXTS = {
    "spam": (
        "Здравствуйте, уважаемая поддержка. На вашей платформе я нашел пользователя который отправляет много ненужных сообщений - СПАМ. "
        "Его юзернейм - {username}, его айди - {user_id}, ссылка на чат - {chat_link}, ссылка на нарушения - {violation_link}. "
        "Пожалуйста примите меры по отношению к данному пользователю."
    ),
    "doxing": (
        "Здравствуйте, уважаемая поддержка, на вашей платформе я нашел пользователя, который распространяет чужие данные без их согласия. "
        "его юзернейм - {username}, его айди - {user_id}, ссылка на чат - {chat_link}, ссылка на нарушение/нарушения - {violation_link}. "
        "Пожалуйста примите меры по отношению к данному пользователю путем блокировки его акккаунта."
    ),
    "abuse": (
        "Здравствуйте, уважаемая поддержка телеграм. Я нашел пользователя который открыто выражается нецензурной лексикой и спамит в чатах. "
        "его юзернейм - {username}, его айди - {user_id}, ссылка на чат - {chat_link}, ссылка на нарушение/нарушения - {violation_link}. "
        "Пожалуйста примите меры по отношению к данному пользователю путем блокировки его акккаунта."
    ),
    "session": (
        "Здравствуйте, уважаемая поддержка. Я случайно перешел по фишинговой ссылке и утерял доступ к своему аккаунту. "
        "Его юзернейм - {username}, его айди - {user_id}. Пожалуйста удалите аккаунт или обнулите сессии"
    ),
    "premium": (
        "Добрый день поддержка Telegram! Аккаунт {username}, {user_id} приобрёл премиум в вашем мессенджере чтобы рассылать "
        "спам-сообщения и обходить ограничения Telegram. Прошу проверить данную жалобу и принять меры!"
    ),
    "virtual": (
        "Добрый день поддержка Telegram! Аккаунт {username}, {user_id} использует виртуальный номер купленный на сайте по активации номеров. "
        "Отношения к номеру он не имеет, номер никак к нему не относиться. Прошу разберитесь с этим. Заранее спасибо!"
    ),
    "personal_data": (
        "Здравствуйте, уважаемая поддержка телеграм. На вашей платформе я нашел канал, который распространяет личные данные невинных людей. "
        "Ссылка на канал - {channel_link}, ссылки на нарушения - {violation_link}. Пожалуйста заблокируйте данный канал."
    ),
    "animal_abuse": (
        "Здравствуйте, уважаемая поддержка телеграма. На вашей платформе я нашел канал который распространяет жестокое обращение с животными. "
        "Ссылка на канал - {channel_link}, ссылки на нарушения - {violation_link}. Пожалуйста заблокируйте данный канал."
    ),
    "cp": (
        "Здравствуйте, уважаемая поддержка телеграма. На вашей платформе я нашел канал который распространяет порнографию с участием несовершеннолетних. "
        "Ссылка на канал - {channel_link}, ссылки на нарушения - {violation_link}. Пожалуйста заблокируйте данный канал."
    ),
    "drugs": (
        "Здравствуйте, уважаемый модератор телеграмм, хочу пожаловаться вам на канал, который продает услуги доксинга, сваттинга. "
        "Ссылка на телеграмм канал: {channel_link} Ссылка на нарушение: {violation_link} Просьба заблокировать данный канал."
    ),
    "bot_doxing": (
        "Здравствуйте, уважаемая поддержка телеграм. На вашей платформе я нашел бота, который осуществляет поиск по личным данным ваших пользователей. "
        "Ссылка на бота - {bot_username}. Пожалуйста разберитесь и заблокируйте данного бота."
    )
}

# Инициализация Flask и Telegram бота
app = Flask(__name__)
bot = telebot.TeleBot(Config.BOT_TOKEN)

def send_email(receiver, sender_email, sender_password, subject, body):
    try:
        msg = MIMEMultipart()
        msg['From'] = sender_email
        msg['To'] = receiver
        msg['Subject'] = subject
        msg.attach(MIMEText(body, 'plain'))
        
        with smtplib.SMTP('smtp.mail.ru', 587) as server:
            server.starttls()
            server.login(sender_email, sender_password)
            server.sendmail(sender_email, receiver, msg.as_string())
            time.sleep(3)
        return True
    except Exception as e:
        logger.error(f"Ошибка при отправке email: {e}")
        return False

@app.route('/api/complaint', methods=['POST'])
def handle_complaint():
    try:
        data = request.json
        logger.info(f"Получены данные: {data}")
        
        complaint_type = data.get('type')
        if not complaint_type:
            return jsonify({"status": "error", "message": "Тип жалобы не указан"}), 400
        
        required_fields = []
        if complaint_type in ["spam", "doxing", "abuse"]:
            required_fields = ['username', 'user_id', 'chat_link', 'violation_link']
        elif complaint_type in ["session", "premium", "virtual"]:
            required_fields = ['username', 'user_id']
        elif complaint_type in ["personal_data", "animal_abuse", "cp", "drugs"]:
            required_fields = ['channel_link', 'violation_link']
        elif complaint_type == "bot_doxing":
            required_fields = ['bot_username']
        
        missing_fields = [f for f in required_fields if f not in data]
        if missing_fields:
            return jsonify({"status": "error", "message": f"Отсутствуют поля: {', '.join(missing_fields)}"}), 400
        
        Thread(target=process_complaint, args=(data,)).start()
        return jsonify({"status": "success", "message": "Жалоба принята в обработку"})
    
    except Exception as e:
        logger.error(f"Ошибка обработки жалобы: {e}")
        return jsonify({"status": "error", "message": "Внутренняя ошибка сервера"}), 500

def process_complaint(data):
    try:
        complaint_type = data['type']
        body = COMPLAINT_TEXTS[complaint_type].format(**data)
        subject = {
            "spam": "Жалоба на спам",
            "doxing": "Жалоба на доксинг",
            "abuse": "Жалоба на оскорбления",
            "session": "Запрос на удаление сессий",
            "premium": "Жалоба на премиум аккаунт",
            "virtual": "Жалоба на виртуальный номер",
            "personal_data": "Жалоба на распространение личных данных",
            "animal_abuse": "Жалоба на жестокое обращение с животными",
            "cp": "Жалоба на запрещенный контент",
            "drugs": "Жалоба на продажу запрещенных веществ",
            "bot_doxing": "Жалоба на бота для доксинга"
        }.get(complaint_type, "Жалоба Telegram")
        
        total_sent = 0
        for sender_email, sender_password in SENDERS.items():
            for receiver in RECEIVERS:
                if send_email(receiver, sender_email, sender_password, subject, body):
                    total_sent += 1
                time.sleep(Config.REQUEST_DELAY)
        
        logger.info(f"Отправлено {total_sent} жалоб типа {complaint_type}")
        notify_admin(f"Отправлено {total_sent} жалоб типа {complaint_type}")
        
    except Exception as e:
        logger.error(f"Ошибка обработки жалобы: {e}")

def notify_admin(message):
    for admin_id in Config.ADMIN_IDS:
        try:
            bot.send_message(admin_id, message)
        except Exception as e:
            logger.error(f"Ошибка уведомления админа: {e}")

@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = types.InlineKeyboardMarkup()
    btn = types.InlineKeyboardButton(
        text="Открыть TG KILLER", 
        web_app=types.WebAppInfo(url=f"{Config.WEBAPP_URL}/webapp")
    )
    markup.add(btn)
    
    bot.send_message(
        message.chat.id,
        "🔹 <b>TG KILLER WebApp</b> by @russianplanter\n\n"
        "Нажмите кнопку ниже, чтобы открыть интерфейс для отправки жалоб\n\n"
        "Используйте только в образовательных целях!",
        reply_markup=markup,
        parse_mode='HTML'
    )

# HTML для WebApp
WEBAPP_HTML = """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG KILLER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-color: #0088cc;
            --secondary-color: #f5f5f5;
            --error-color: #dc3545;
            --success-color: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: var(--secondary-color);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #006699;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        .success {
            background-color: var(--success-color);
            color: white;
            display: block;
        }
        
        .error {
            background-color: var(--error-color);
            color: white;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 15px;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>TG KILLER</h2>
            <p>by @russianplanter</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="openTab('account')">Аккаунты</div>
            <div class="tab" onclick="openTab('channel')">Каналы</div>
            <div class="tab" onclick="openTab('bot')">Боты</div>
        </div>
        
        <!-- Аккаунты -->
        <div id="account" class="tab-content active">
            <form id="accountForm">
                <div class="form-group">
                    <label for="accountType">Тип жалобы:</label>
                    <select id="accountType" required>
                        <option value="spam">Спам</option>
                        <option value="doxing">Доксинг</option>
                        <option value="abuse">Оскорбления</option>
                        <option value="session">Удаление сессий</option>
                        <option value="premium">Премка для спама</option>
                        <option value="virtual">Вирт номер</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accountUsername">Юзернейм (с @):</label>
                    <input type="text" id="accountUsername" placeholder="@username" required>
                </div>
                
                <div class="form-group">
                    <label for="accountId">ID аккаунта:</label>
                    <input type="text" id="accountId" placeholder="123456789" required>
                </div>
                
                <div id="accountExtraFields">
                    <div class="form-group">
                        <label for="accountChatLink">Ссылка на чат:</label>
                        <input type="text" id="accountChatLink" placeholder="https://t.me/chat">
                    </div>
                    
                    <div class="form-group">
                        <label for="accountViolationLink">Ссылка на нарушение:</label>
                        <input type="text" id="accountViolationLink" placeholder="https://t.me/...">
                    </div>
                </div>
                
                <button type="submit">Отправить жалобу</button>
            </form>
            
            <div id="accountStatus" class="status"></div>
            <div id="accountLoading" class="loading">
                <div class="spinner"></div>
                <p>Отправка жалоб...</p>
            </div>
        </div>
        
        <!-- Каналы -->
        <div id="channel" class="tab-content">
            <form id="channelForm">
                <div class="form-group">
                    <label for="channelType">Тип жалобы:</label>
                    <select id="channelType" required>
                        <option value="personal_data">Личные данные</option>
                        <option value="animal_abuse">Жестокость</option>
                        <option value="cp">Запрещенный контент</option>
                        <option value="drugs">Продажа запрещенных веществ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="channelLink">Ссылка на канал:</label>
                    <input type="text" id="channelLink" placeholder="https://t.me/channel" required>
                </div>
                
                <div class="form-group">
                    <label for="channelViolationLink">Ссылка на нарушение:</label>
                    <input type="text" id="channelViolationLink" placeholder="https://t.me/..." required>
                </div>
                
                <button type="submit">Отправить жалобу</button>
            </form>
            
            <div id="channelStatus" class="status"></div>
            <div id="channelLoading" class="loading">
                <div class="spinner"></div>
                <p>Отправка жалоб...</p>
            </div>
        </div>
        
        <!-- Боты -->
        <div id="bot" class="tab-content">
            <form id="botForm">
                <div class="form-group">
                    <label for="botType">Тип жалобы:</label>
                    <select id="botType" required>
                        <option value="bot_doxing">Бот для доксинга</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="botUsername">Юзернейм бота (с @):</label>
                    <input type="text" id="botUsername" placeholder="@bot_username" required>
                </div>
                
                <button type="submit">Отправить жалобу</button>
            </form>
            
            <div id="botStatus" class="status"></div>
            <div id="botLoading" class="loading">
                <div class="spinner"></div>
                <p>Отправка жалоб...</p>
            </div>
        </div>
    </div>

    <script>
        // Инициализация WebApp Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Показываем кнопку "Назад"
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            tg.close();
        });
        
        // Переключение вкладок
        function openTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Деактивировать все табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            document.getElementById(tabName).classList.add('active');
            
            // Активировать выбранный таб
            event.currentTarget.classList.add('active');
            
            // Показываем/скрываем дополнительные поля для аккаунтов
            if (tabName === 'account') {
                toggleAccountFields();
            }
        }
        
        // Показываем/скрываем дополнительные поля для аккаунтов
        function toggleAccountFields() {
            const accountType = document.getElementById('accountType').value;
            const extraFields = document.getElementById('accountExtraFields');
            
            if (['spam', 'doxing', 'abuse'].includes(accountType)) {
                extraFields.style.display = 'block';
                document.getElementById('accountChatLink').required = true;
                document.getElementById('accountViolationLink').required = true;
            } else {
                extraFields.style.display = 'none';
                document.getElementById('accountChatLink').required = false;
                document.getElementById('accountViolationLink').required = false;
            }
        }
        
        // Обработчик изменения типа жалобы для аккаунтов
        document.getElementById('accountType').addEventListener('change', toggleAccountFields);
        
        // Обработчики отправки форм
        document.getElementById('accountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitComplaint('account');
        });
        
        document.getElementById('channelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitComplaint('channel');
        });
        
        document.getElementById('botForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitComplaint('bot');
        });
        
        // Функция отправки жалобы
        function submitComplaint(formType) {
            const form = document.getElementById(`${formType}Form`);
            const loading = document.getElementById(`${formType}Loading`);
            const status = document.getElementById(`${formType}Status`);
            
            // Собираем данные
            let type, data;
            
            if (formType === 'account') {
                type = document.getElementById('accountType').value;
                data = {
                    username: document.getElementById('accountUsername').value,
                    user_id: document.getElementById('accountId').value
                };
                
                if (['spam', 'doxing', 'abuse'].includes(type)) {
                    data.chat_link = document.getElementById('accountChatLink').value;
                    data.violation_link = document.getElementById('accountViolationLink').value;
                }
            } 
            else if (formType === 'channel') {
                type = document.getElementById('channelType').value;
                data = {
                    channel_link: document.getElementById('channelLink').value,
                    violation_link: document.getElementById('channelViolationLink').value
                };
            } 
            else if (formType === 'bot') {
                type = document.getElementById('botType').value;
                data = {
                    bot_username: document.getElementById('botUsername').value
                };
            }
            
            // Показываем загрузку
            loading.style.display = 'block';
            status.style.display = 'none';
            form.style.opacity = '0.5';
            form.querySelector('button').disabled = true;
            
            // Отправляем данные на сервер
            fetch('/api/complaint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: type,
                    ...data
                })
            })
            .then(response => response.json())
            .then(result => {
                loading.style.display = 'none';
                form.style.opacity = '1';
                form.querySelector('button').disabled = false;
                
                if (result.status === 'success') {
                    status.className = 'status success';
                    status.textContent = 'Жалоба успешно отправлена!';
                    form.reset();
                } else {
                    status.className = 'status error';
                    status.textContent = 'Ошибка: ' + result.message;
                }
                
                status.style.display = 'block';
            })
            .catch(error => {
                loading.style.display = 'none';
                form.style.opacity = '1';
                form.querySelector('button').disabled = false;
                
                status.className = 'status error';
                status.textContent = 'Ошибка соединения: ' + error.message;
                status.style.display = 'block';
                
                console.error('Error:', error);
            });
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            toggleAccountFields();
        });
    </script>
</body>
</html>
"""

@app.route('/webapp')
def webapp():
    return render_template_string(WEBAPP_HTML)

if __name__ == '__main__':
    # Запуск Flask и бота в разных потоках
    from threading import Thread
    Thread(target=app.run, kwargs={
        'host': Config.WEBAPP_HOST,
        'port': Config.WEBAPP_PORT
    }).start()
    
    logger.info("Запуск бота...")
    bot.infinity_polling()
