<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --space-dark: #0B0D21;
            --neon-blue: #00F3FF;
            --star-yellow: #FFE81F;
            --planet-purple: #6C63FF;
            --danger-red: #FF4D4D;
            --success-green: #00CC88;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--space-dark);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .space-background {
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: 
                radial-gradient(circle at 20% 80%, var(--planet-purple), transparent 30%),
                radial-gradient(circle at 80% 20%, var(--neon-blue), transparent 30%),
                linear-gradient(to bottom, #000000, var(--space-dark));
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--neon-blue);
            color: var(--space-dark);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 243, 255, 0.3);
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .ticket-card {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ticket-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 243, 255, 0.05);
            user-select: none;
        }

        .ticket-body {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .ticket-expanded .ticket-body {
            max-height: 1000px;
            padding: 15px;
        }

        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            position: relative;
            background: rgba(255,255,255,0.1);
        }

        .admin-message {
            background: rgba(108, 99, 255, 0.15);
            border-left: 3px solid var(--planet-purple);
        }

        .user-message {
            background: rgba(0, 243, 255, 0.15);
            border-left: 3px solid var(--neon-blue);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .open { background: var(--success-green); }
        .closed { background: var(--danger-red); }

        .priority-tag {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            background: rgba(255, 232, 31, 0.15);
            color: var(--star-yellow);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: var(--space-dark);
            backdrop-filter: blur(5px);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        form {
            display: grid;
            gap: 15px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="space-background"></div>

    <div id="loadingScreen" class="container" style="color: white; text-align: center; padding-top: 100px;">
        <h2>üõ∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</h2>
        <div class="spinner"></div>
    </div>

    <div id="appContent" class="hidden">
        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="userInterface" class="container">
            <div class="card">
                <h1 style="color: var(--neon-blue);">üöÄ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
                <form id="ticketForm">
                    <input type="text" id="subject" placeholder="–¢–µ–º–∞ –≤–æ–ø—Ä–æ—Å–∞" required>
                    <select id="priority" required>
                        <option value="low">üåå –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="medium" selected>üõ∏ –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="high">üö® –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    </select>
                    <textarea id="problem" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..." required></textarea>
                    <button type="submit" class="btn">üì° –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                </form>
            </div>

            <div class="card">
                <h2>üì¨ –ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</h2>
                <div id="ticketsContainer"></div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div id="adminPanel" class="container hidden">
            <div class="card">
                <h2 style="color: var(--planet-purple);">üëæ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="adminSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º..." style="flex: 1;">
                    <select id="filterStatus">
                        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="open">–û—Ç–∫—Ä—ã—Ç—ã–µ</option>
                        <option value="closed">–ó–∞–∫—Ä—ã—Ç—ã–µ</option>
                    </select>
                </div>
                <div id="adminTicketsContainer"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "rfIdLaULMIe2uo0h3pygEj3lNjAUWrkEOgsyhSD1nE8",
            databaseURL: "https://stars-207f2-default-rtdb.firebaseio.com"
        };

        // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        const ADMIN_IDS = ['1290724329', '1062148525'];
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = { 
            id: null, 
            username: '–ì–æ—Å—Ç—å', 
            isAdmin: false 
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await initUser();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
                setupEventListeners();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                await renderContent();
                
                // –°–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                toggleLoader(false);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã', 'error');
                toggleLoader(false);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initUser() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                currentUser.id = tgUser.id.toString();
                currentUser.username = tgUser.username || 
                    [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || 
                    '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            } else {
                // –ì–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø
                currentUser.id = 'guest_' + Math.random().toString(36).substr(2, 9);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            currentUser.isAdmin = ADMIN_IDS.includes(currentUser.id);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
            toggleUserInterface();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
        function toggleUserInterface() {
            const userInterface = document.getElementById('userInterface');
            const adminPanel = document.getElementById('adminPanel');
            
            if (currentUser.isAdmin) {
                userInterface.classList.add('hidden');
                adminPanel.classList.remove('hidden');
            } else {
                userInterface.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
            document.getElementById('ticketForm').addEventListener('submit', handleSubmit);
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            document.getElementById('adminSearch').addEventListener('input', () => renderAdminTickets());
            document.getElementById('filterStatus').addEventListener('change', () => renderAdminTickets());
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.addEventListener('click', handleActions);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function handleSubmit(e) {
            e.preventDefault();
            
            try {
                // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
                const newTicket = createTicketObject();
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
                await database.ref(`tickets/${newTicket.id}`).set(newTicket);
                
                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                document.getElementById('ticketForm').reset();
                showNotification('üöÄ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                renderContent();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–∏–∫–µ—Ç–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞', 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Ç–∏–∫–µ—Ç–∞
        function createTicketObject() {
            return {
                id: generateId(),
                userId: currentUser.id,
                username: currentUser.username,
                subject: document.getElementById('subject').value.trim(),
                problem: document.getElementById('problem').value.trim(),
                priority: document.getElementById('priority').value,
                status: 'open',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                messages: []
            };
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        async function renderContent() {
            try {
                if (currentUser.isAdmin) {
                    await renderAdminTickets();
                } else {
                    const tickets = await loadUserTickets();
                    renderUserTickets(tickets);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserTickets() {
            try {
                const snapshot = await database.ref('tickets')
                    .orderByChild('userId')
                    .equalTo(currentUser.id)
                    .once('value');
                
                return parseFirebaseData(snapshot);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤:', error);
                throw error;
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        async function renderAdminTickets() {
            try {
                const snapshot = await database.ref('tickets').once('value');
                const allTickets = parseFirebaseData(snapshot);
                const filteredTickets = filterTickets(allTickets);
                
                document.getElementById('adminTicketsContainer').innerHTML = 
                    filteredTickets.map(t => createAdminTicketElement(t)).join('');
                    
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤:', error);
                throw error;
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤
        function filterTickets(tickets) {
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            return tickets
                .filter(t => !ADMIN_IDS.includes(t.userId)) // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–∏–∫–µ—Ç—ã –∞–¥–º–∏–Ω–æ–≤
                .filter(t => statusFilter === 'all' || t.status === statusFilter)
                .filter(t => 
                    t.userId.includes(searchTerm) ||
                    t.subject.toLowerCase().includes(searchTerm) ||
                    t.problem.toLowerCase().includes(searchTerm)
                )
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function renderUserTickets(tickets) {
            const container = document.getElementById('ticketsContainer');
            
            if (tickets.length === 0) {
                container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</p>';
                return;
            }
            
            container.innerHTML = tickets
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .map(t => createUserTicketElement(t))
                .join('');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ç–∏–∫–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function createUserTicketElement(ticket) {
            return `
                <div class="ticket-card ${ticket.status}" data-id="${ticket.id}">
                    <div class="ticket-header">
                        <div style="display: flex; align-items: center;">
                            <div class="status-indicator ${ticket.status}"></div>
                            <h3 style="margin: 0">${ticket.subject}</h3>
                        </div>
                        <div class="priority-tag">${getPriorityLabel(ticket.priority)}</div>
                    </div>
                    <div class="ticket-body">
                        <div class="messages">${renderMessages(ticket)}</div>
                        ${ticket.status === 'open' ? createReplyForm(ticket.id, false) : ''}
                    </div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ç–∏–∫–µ—Ç–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function createAdminTicketElement(ticket) {
            return `
                <div class="ticket-card ${ticket.status}" data-id="${ticket.id}">
                    <div class="ticket-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="status-indicator ${ticket.status}"></div>
                            <div>
                                <h3 style="margin: 0">${ticket.subject}</h3>
                                <small>${ticket.username} ‚Ä¢ ${formatDate(ticket.createdAt)}</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div class="priority-tag">${getPriorityLabel(ticket.priority)}</div>
                            ${createAdminControls(ticket)}
                        </div>
                    </div>
                    <div class="ticket-body">
                        <div class="messages">${renderMessages(ticket)}</div>
                        ${createReplyForm(ticket.id, true, ticket.status)}
                    </div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
        function createAdminControls(ticket) {
            return ticket.status === 'open' ? 
                `<button class="btn btn-danger close-btn" data-id="${ticket.id}">–ó–∞–∫—Ä—ã—Ç—å</button>` :
                `<button class="btn btn-success reopen-btn" data-id="${ticket.id}">–û—Ç–∫—Ä—ã—Ç—å</button>`;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
        function handleActions(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞
            if (e.target.closest('.reply-form')) {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞, –Ω–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∏–∫–µ—Ç
                return;
            }

            const actions = {
                'close-btn': closeTicket,
                'reopen-btn': reopenTicket,
                'send-reply': (id) => sendReply(id, true),
                'send-user-reply': (id) => sendReply(id, false),
                'ticket-header': (el) => toggleTicket(el)
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É —Ç–∏–∫–µ—Ç–∞
            if (e.target.closest('.ticket-header')) {
                actions['ticket-header'](e.target.closest('.ticket-header'));
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
            for (const [cls, action] of Object.entries(actions)) {
                if (e.target.classList.contains(cls)) {
                    action(e.target.dataset.id);
                    return;
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        async function sendReply(ticketId, isAdmin) {
            const textareaId = isAdmin ? `adminReply-${ticketId}` : `userReply-${ticketId}`;
            const text = document.getElementById(textareaId)?.value.trim();
            
            if (!text) {
                showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                return;
            }

            try {
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const message = {
                    message: text,
                    timestamp: new Date().toISOString(),
                    isAdmin
                };

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
                await database.ref(`tickets/${ticketId}/messages`).push(message);
                await database.ref(`tickets/${ticketId}/updatedAt`).set(new Date().toISOString());
                
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                document.getElementById(textareaId).value = '';
                showNotification(isAdmin ? 'üëæ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' : 'üöÄ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                renderContent();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞
        async function closeTicket(ticketId) {
            await updateTicketStatus(ticketId, 'closed', 'üîí –ó–∞–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç');
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞
        async function reopenTicket(ticketId) {
            await updateTicketStatus(ticketId, 'open', 'üîì –ó–∞–ø—Ä–æ—Å –æ—Ç–∫—Ä—ã—Ç');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∏–∫–µ—Ç–∞
        async function updateTicketStatus(ticketId, status, message) {
            try {
                await database.ref(`tickets/${ticketId}/status`).set(status);
                await database.ref(`tickets/${ticketId}/updatedAt`).set(new Date().toISOString());
                
                showNotification(message);
                renderContent();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
        function toggleTicket(element) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –ø–æ —Å–∞–º–æ–º—É –∑–∞–≥–æ–ª–æ–≤–∫—É (–∞ –Ω–µ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º)
            if (element.classList.contains('ticket-header')) {
                element.closest('.ticket-card').classList.toggle('ticket-expanded');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function parseFirebaseData(snapshot) {
            if (!snapshot.val()) return [];
            return Object.entries(snapshot.val()).map(([id, value]) => ({ id, ...value }));
        }

        function getPriorityLabel(priority) {
            const labels = {
                low: 'üåå –ù–∏–∑–∫–∏–π',
                medium: 'üõ∏ –°—Ä–µ–¥–Ω–∏–π',
                high: 'üö® –í—ã—Å–æ–∫–∏–π'
            };
            return labels[priority] || 'üõ∏ –°—Ä–µ–¥–Ω–∏–π';
        }

        function formatDate(dateString) {
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return new Date(dateString).toLocaleString('ru-RU', options);
        }

        function renderMessages(ticket) {
            const messages = [
                createMessage(ticket.problem, ticket.username, ticket.createdAt, false),
                ...(ticket.messages ? Object.values(ticket.messages) : []).map(msg => 
                    createMessage(msg.message, msg.isAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : ticket.username, msg.timestamp, msg.isAdmin)
                )
            ];
            return messages.join('');
        }

        function createMessage(text, author, date, isAdmin) {
            return `
                <div class="message ${isAdmin ? 'admin-message' : 'user-message'}">
                    <div class="message-text">${text}</div>
                    <div class="message-info">${author} ‚Ä¢ ${formatDate(date)}</div>
                </div>
            `;
        }

        function createReplyForm(ticketId, isAdmin, status = 'open') {
            if (status !== 'open') return '';
            
            return `
                <div class="reply-form">
                    <textarea id="${isAdmin ? 'admin' : 'user'}Reply-${ticketId}" 
                              placeholder="${isAdmin ? '–í–∞—à –æ—Ç–≤–µ—Ç...' : '–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...'}"></textarea>
                    <button class="btn ${isAdmin ? 'btn-success' : ''} ${isAdmin ? 'send-reply' : 'send-user-reply'}" 
                            data-id="${ticketId}">
                        ${isAdmin ? 'üì° –û—Ç–≤–µ—Ç–∏—Ç—å' : 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å'}
                    </button>
                </div>
            `;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function toggleLoader(show = true) {
            document.getElementById('loadingScreen').classList.toggle('hidden', !show);
            document.getElementById('appContent').classList.toggle('hidden', show);
        }
    </script>
</body>
</html>
